default_platform(:android)

platform :android do
  desc "Capture Play Store screenshots on Android emulators"
  lane :screenshots do
    devices = [
      "Pixel_8_Pro",
      "Pixel_Tablet",
    ]

    devices.each do |device|
      UI.message("ðŸ“¸ Capturing screenshots on #{device}...")

      sh("#{ENV['ANDROID_HOME']}/emulator/emulator -avd '#{device}' -no-audio -no-window &")
      sh("adb wait-for-device")

      sh("adb shell settings put global sysui_demo_allowed 1")
      sh("adb shell am broadcast -a com.android.systemui.demo -e command clock -e hhmm 0941")
      sh("adb shell am broadcast -a com.android.systemui.demo -e command battery -e level 100 -e plugged false")
      sh("adb shell am broadcast -a com.android.systemui.demo -e command network -e wifi show -e level 4")
      sh("adb shell am broadcast -a com.android.systemui.demo -e command notifications -e visible false")

      sh("cd '#{ENV['PWD']}/..' && " \
         "flutter test integration_test/screenshots/screenshot_test.dart " \
         "-d '#{device}'")

      sh("adb shell am broadcast -a com.android.systemui.demo -e command exit")
    end

    UI.success("âœ… All Android screenshots captured!")
  end
end
