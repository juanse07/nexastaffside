default_platform(:android)

platform :android do
  desc "Capture Play Store screenshots on Android emulators"
  lane :screenshots do
    devices = [
      "Pixel_8_Pro",
      "Pixel_Tablet",
    ]

    devices.each do |device|
      UI.message("ðŸ“¸ Capturing screenshots on #{device}...")

      sh("#{ENV['ANDROID_HOME']}/emulator/emulator -avd '#{device}' -no-audio -no-window &")
      sh("adb wait-for-device")

      sh("adb shell settings put global sysui_demo_allowed 1")
      sh("adb shell am broadcast -a com.android.systemui.demo -e command clock -e hhmm 0941")
      sh("adb shell am broadcast -a com.android.systemui.demo -e command battery -e level 100 -e plugged false")
      sh("adb shell am broadcast -a com.android.systemui.demo -e command network -e wifi show -e level 4")
      sh("adb shell am broadcast -a com.android.systemui.demo -e command notifications -e visible false")

      sh("cd '#{ENV['PWD']}/..' && " \
         "flutter test integration_test/screenshots/screenshot_test.dart " \
         "-d '#{device}'")

      sh("adb shell am broadcast -a com.android.systemui.demo -e command exit")
    end

    UI.success("âœ… All Android screenshots captured!")
  end

  desc "Pull existing Play Console metadata into local files (run once to seed)"
  lane :download_metadata do
    download_from_play_store(
      track: "internal",
      metadata_path: "./fastlane/metadata/android"
    )
  end

  desc "Push local metadata/screenshots to Play Console (no binary upload)"
  lane :update_metadata do
    upload_to_play_store(
      track: "internal",
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      skip_upload_changelogs: true,
      changes_not_sent_for_review: true,
      metadata_path: "./fastlane/metadata/android"
    )
  end

  desc "Build release AAB and upload to internal testing track"
  lane :deploy_internal do
    sh("cd ../.. && flutter build appbundle --release")
    upload_to_play_store(
      track: "internal",
      aab: "../../build/app/outputs/bundle/release/app-release.aab",
      metadata_path: "./fastlane/metadata/android",
      skip_upload_screenshots: true,
      skip_upload_images: true
    )
  end

  desc "Promote internal build to production"
  lane :promote_to_production do
    upload_to_play_store(
      track: "internal",
      track_promote_to: "production"
    )
  end
end
